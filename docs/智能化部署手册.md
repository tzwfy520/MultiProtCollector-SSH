# SSH Collector 智能化部署手册

## 概述

SSH Collector 智能化部署系统提供了自动化的容器部署解决方案，具备智能端口检测和分配功能，确保服务能够在最优的端口上运行。

## 功能特性

### 🚀 智能端口分配
- **自动检测**: 自动检测服务器可用端口
- **智能分配**: 从默认端口8000开始，如果被占用则自动顺延到下一个可用端口
- **范围扫描**: 支持8000-8100端口范围内的智能扫描
- **冲突避免**: 避免端口冲突，确保服务稳定运行

### 🔧 自动化部署
- **一键部署**: 单个命令完成整个部署流程
- **容器管理**: 自动清理旧容器，启动新容器
- **状态验证**: 自动验证容器运行状态和端口监听
- **错误处理**: 完善的错误处理和日志输出

### 📊 实时监控
- **状态检查**: 实时检查容器运行状态
- **端口监听**: 验证端口监听是否正常
- **日志输出**: 彩色日志输出，便于问题排查

## 部署架构

```
SSH Collector 智能化部署架构
┌─────────────────────────────────────────┐
│              部署脚本                    │
│         smart-deploy.sh                 │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│            端口检测模块                  │
│   • 检测8000端口可用性                   │
│   • 自动顺延到可用端口                   │
│   • 范围: 8000-8100                     │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│            容器管理模块                  │
│   • 停止现有容器                        │
│   • 删除旧容器                          │
│   • 启动新容器                          │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│         SSH Collector 容器               │
│   • 镜像ID: cc12b8437b73                │
│   • 内部端口: 8000                      │
│   • 外部端口: 动态分配                   │
└─────────────────────────────────────────┘
```

## 快速开始

### 前置条件

1. **Docker 环境**
   ```bash
   # 检查Docker是否运行
   docker info
   ```

2. **镜像准备**
   ```bash
   # 确认镜像存在
   docker images | grep cc12b8437b73
   ```

3. **脚本权限**
   ```bash
   # 确保脚本有执行权限
   chmod +x scripts/deploy/smart-deploy.sh
   ```

### 本地部署

```bash
# 进入部署目录
cd scripts/deploy

# 执行智能化部署
./smart-deploy.sh
```

### 远程部署

```bash
# 上传脚本到远程服务器
scp smart-deploy.sh user@server:/opt/ssh-collector/

# SSH登录到远程服务器
ssh user@server

# 执行部署
cd /opt/ssh-collector
./smart-deploy.sh
```

## 部署流程详解

### 1. 环境检查阶段
```
[INFO] SSH Collector 智能化部署脚本
[INFO] 检查Docker服务状态...
[INFO] 验证镜像cc12b8437b73存在性...
```

### 2. 端口检测阶段
```
[INFO] 开始检测可用端口，从 8000 开始...
[WARNING] 端口 8000 已被占用，尝试下一个端口...
[WARNING] 端口 8001 已被占用，尝试下一个端口...
[SUCCESS] 找到可用端口: 8002
```

### 3. 容器管理阶段
```
[INFO] 清理现有容器...
[INFO] 停止现有容器: ssh-collector
[INFO] 删除现有容器: ssh-collector
[SUCCESS] 现有容器已清理完成
```

### 4. 容器启动阶段
```
[INFO] 使用镜像 cc12b8437b73 启动新容器...
[INFO] 端口映射: 8002:8000
[SUCCESS] 容器启动成功！
```

### 5. 状态验证阶段
```
[INFO] 验证容器状态...
[SUCCESS] 容器运行状态正常
[SUCCESS] 端口 8002 监听正常
```

### 6. 部署完成
```
==========================================
SSH Collector 部署完成
==========================================
容器名称: ssh-collector
镜像ID: cc12b8437b73
主机端口: 8002
容器端口: 8000
访问地址: http://localhost:8002
==========================================
```

## 配置参数

### 脚本配置变量

| 变量名 | 默认值 | 说明 |
|--------|--------|------|
| `DEFAULT_PORT` | 8000 | 默认起始端口 |
| `CONTAINER_NAME` | ssh-collector | 容器名称 |
| `IMAGE_ID` | cc12b8437b73 | Docker镜像ID |
| `MAX_PORT_SCAN` | 8100 | 最大扫描端口 |

### 自定义配置

如需修改配置，编辑脚本文件：

```bash
# 修改默认端口范围
DEFAULT_PORT=9000
MAX_PORT_SCAN=9100

# 修改容器名称
CONTAINER_NAME="my-ssh-collector"

# 修改镜像ID
IMAGE_ID="your-image-id"
```

## 故障排除

### 常见问题

#### 1. Docker服务未运行
```
[ERROR] Docker 未运行或无法访问，请检查Docker服务状态
```
**解决方案:**
```bash
# 启动Docker服务
sudo systemctl start docker
# 或
sudo service docker start
```

#### 2. 镜像不存在
```
[ERROR] 镜像 cc12b8437b73 不存在，请先构建镜像
```
**解决方案:**
```bash
# 构建镜像
docker build -t ssh-collector .
# 或导入镜像
docker load -i ssh-collector.tar
```

#### 3. 无可用端口
```
[ERROR] 在范围 8000-8100 内未找到可用端口
```
**解决方案:**
- 检查并释放占用的端口
- 扩大端口扫描范围
- 修改`MAX_PORT_SCAN`参数

#### 4. 容器启动失败
```
[ERROR] 容器启动失败
```
**解决方案:**
```bash
# 查看详细错误日志
docker logs ssh-collector

# 检查镜像完整性
docker inspect cc12b8437b73

# 手动启动测试
docker run -it --rm cc12b8437b73 /bin/bash
```

### 日志分析

#### 日志级别说明
- `[INFO]`: 信息性消息，正常流程
- `[SUCCESS]`: 成功操作确认
- `[WARNING]`: 警告信息，需要注意
- `[ERROR]`: 错误信息，需要处理

#### 调试模式
```bash
# 启用详细日志
set -x
./smart-deploy.sh

# 查看容器日志
docker logs -f ssh-collector
```

## 高级功能

### 1. 批量部署

创建批量部署脚本：

```bash
#!/bin/bash
# batch-deploy.sh

servers=(
    "server1.example.com"
    "server2.example.com"
    "server3.example.com"
)

for server in "${servers[@]}"; do
    echo "部署到服务器: $server"
    scp smart-deploy.sh $server:/tmp/
    ssh $server "cd /tmp && ./smart-deploy.sh"
done
```

### 2. 健康检查

添加健康检查功能：

```bash
# 健康检查脚本
check_health() {
    local port=$1
    local max_attempts=30
    local attempt=1
    
    while [ $attempt -le $max_attempts ]; do
        if curl -f http://localhost:$port/health >/dev/null 2>&1; then
            log_success "健康检查通过"
            return 0
        fi
        
        log_info "健康检查尝试 $attempt/$max_attempts..."
        sleep 2
        attempt=$((attempt + 1))
    done
    
    log_error "健康检查失败"
    return 1
}
```

### 3. 配置文件支持

支持外部配置文件：

```bash
# config.env
DEFAULT_PORT=8000
MAX_PORT_SCAN=8100
CONTAINER_NAME=ssh-collector
IMAGE_ID=cc12b8437b73
RESTART_POLICY=unless-stopped
```

```bash
# 在脚本中加载配置
if [ -f "config.env" ]; then
    source config.env
    log_info "已加载配置文件: config.env"
fi
```

## 监控和维护

### 1. 容器监控

```bash
# 查看容器状态
docker ps --filter "name=ssh-collector"

# 查看容器资源使用
docker stats ssh-collector

# 查看容器日志
docker logs -f ssh-collector --tail 100
```

### 2. 端口监控

```bash
# 检查端口监听
netstat -tuln | grep :8000

# 检查端口连接
ss -tuln | grep :8000

# 测试端口连通性
curl -I http://localhost:8000
```

### 3. 自动化监控

创建监控脚本：

```bash
#!/bin/bash
# monitor.sh

check_container_status() {
    if ! docker ps | grep -q ssh-collector; then
        log_error "容器未运行，尝试重启..."
        ./smart-deploy.sh
    fi
}

# 定期检查（可配置到crontab）
while true; do
    check_container_status
    sleep 60
done
```

## 安全考虑

### 1. 端口安全
- 仅开放必要的端口
- 使用防火墙限制访问
- 定期检查端口使用情况

### 2. 容器安全
- 使用非root用户运行容器
- 限制容器资源使用
- 定期更新镜像

### 3. 网络安全
- 使用内部网络通信
- 配置SSL/TLS加密
- 实施访问控制

## 性能优化

### 1. 镜像优化
- 使用多阶段构建
- 减少镜像层数
- 清理不必要文件

### 2. 容器优化
- 设置合适的资源限制
- 优化启动时间
- 配置健康检查

### 3. 网络优化
- 使用Docker网络
- 优化端口映射
- 配置负载均衡

## 版本历史

| 版本 | 日期 | 更新内容 |
|------|------|----------|
| 1.0 | 2024-01-XX | 初始版本，支持智能端口分配和自动化部署 |

## 联系支持

如遇到问题或需要技术支持，请：

1. 查看本手册的故障排除部分
2. 检查容器和系统日志
3. 提供详细的错误信息和环境描述

---

**注意**: 本手册基于SSH Collector v1.0版本编写，请确保使用对应版本的脚本和镜像。