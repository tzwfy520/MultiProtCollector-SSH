# SSH采集器可用自动化脚本清单

## 概述

本文档列出了SSH采集器项目中所有可用的自动化脚本，包括部署脚本、管理脚本和工具脚本。

## 部署脚本

### 1. deploy-ssh-key.sh（推荐）
**功能**: 使用SSH密钥进行自动化部署  
**适用场景**: 生产环境，已配置SSH密钥认证  
**特点**: 
- 最安全的部署方式
- 无需手动输入密码
- 完整的环境检查和验证

**使用方法**:
```bash
# 确保已配置SSH密钥
ssh-copy-id eccom123@115.190.80.219

# 执行部署
./deploy-ssh-key.sh
```

**脚本功能**:
- ✅ SSH连接测试
- ✅ 服务器环境检查
- ✅ Docker和Docker Compose自动安装
- ✅ 部署目录创建
- ✅ 项目文件上传
- ✅ 服务构建和启动
- ✅ 部署验证
- ✅ 日志查看选项

### 2. deploy-to-server.sh
**功能**: 使用密码认证进行自动化部署  
**适用场景**: 测试环境，无SSH密钥配置  
**特点**:
- 自动安装sshpass依赖
- 密码自动输入
- 完整的部署流程

**使用方法**:
```bash
# 直接执行（脚本内置密码）
./deploy-to-server.sh
```

**配置参数**:
```bash
SERVER_IP="115.190.80.219"
USERNAME="eccom123"
PASSWORD="Eccom@12345"
DEPLOY_DIR="/opt/ssh-collector"
```

**脚本功能**:
- ✅ 依赖检查和安装（sshpass）
- ✅ SSH连接测试
- ✅ 服务器环境检查
- ✅ Docker环境安装
- ✅ 项目文件上传
- ✅ 服务构建和启动
- ✅ 部署验证

### 3. deploy-simple.sh
**功能**: 生成部署包并简化部署  
**适用场景**: 网络环境较差，需要离线部署  
**特点**:
- 生成独立部署包
- 减少网络传输
- 包含远程执行脚本

**使用方法**:
```bash
# 生成部署包并执行部署
./deploy-simple.sh
```

**生成文件**:
- `ssh-collector-deploy.tar.gz` - 部署包
- 包含`remote-deploy.sh` - 远程执行脚本

**脚本功能**:
- ✅ 部署包生成
- ✅ 文件上传
- ✅ 远程自动部署
- ✅ 服务验证

## 管理脚本

### 4. healthcheck.sh
**功能**: 服务健康检查  
**适用场景**: Docker容器健康检查，手动服务状态检查  
**特点**:
- 多重检查机制
- 详细的状态报告
- 支持自定义端口

**使用方法**:
```bash
# 直接执行健康检查
./healthcheck.sh

# 在Docker容器中使用
docker-compose exec ssh-collector ./healthcheck.sh
```

**检查项目**:
- ✅ HTTP健康检查接口
- ✅ 进程状态检查
- ✅ 端口监听检查
- ✅ 磁盘空间检查
- ✅ 内存使用检查

### 5. build-optimized.sh
**功能**: 优化的Docker镜像构建  
**适用场景**: 生产环境镜像构建  
**特点**:
- 多阶段构建
- 镜像大小优化
- 安全性增强

**使用方法**:
```bash
# 构建优化镜像
./build-optimized.sh
```

### 6. test-images.sh
**功能**: Docker镜像测试  
**适用场景**: 镜像构建后的功能验证  
**特点**:
- 自动化测试流程
- 多镜像版本测试
- 性能基准测试

**使用方法**:
```bash
# 测试所有镜像
./test-images.sh
```

## 数据库管理脚本

### 7. scripts/init_database.py
**功能**: 数据库初始化  
**适用场景**: 首次部署，数据库重置  
**特点**:
- 自动创建表结构
- 初始数据导入
- 索引创建

**使用方法**:
```bash
# 初始化数据库
python scripts/init_database.py
```

**功能**:
- ✅ 创建数据库表
- ✅ 设置索引
- ✅ 导入初始数据
- ✅ 权限配置

### 8. scripts/migrate_database.py
**功能**: 数据库迁移  
**适用场景**: 版本升级，数据迁移  
**特点**:
- 版本控制
- 数据备份
- 回滚支持

**使用方法**:
```bash
# 执行数据库迁移
python scripts/migrate_database.py

# 导出数据
python scripts/migrate_database.py --export backup.json

# 导入数据
python scripts/migrate_database.py --import backup.json
```

## Docker配置文件

### 9. docker-compose.alpine.yml（推荐）
**功能**: Alpine Linux基础的Docker Compose配置  
**适用场景**: 生产环境部署  
**特点**:
- 镜像体积小
- 安全性高
- 资源占用少

**使用方法**:
```bash
# 使用Alpine版本部署
docker-compose -f docker-compose.alpine.yml up -d
```

### 10. docker-compose.yml
**功能**: 标准Docker Compose配置  
**适用场景**: 开发环境  
**特点**:
- 完整功能
- 调试友好
- 开发工具集成

### 11. docker-compose.multi-stage.yml
**功能**: 多阶段构建配置  
**适用场景**: 优化生产部署  
**特点**:
- 构建优化
- 镜像分层
- 缓存利用

## Dockerfile文件

### 12. Dockerfile.alpine（推荐）
**功能**: Alpine Linux基础镜像  
**特点**:
- 体积最小（~50MB）
- 安全性高
- 启动速度快

### 13. Dockerfile.distroless
**功能**: Distroless基础镜像  
**特点**:
- 极简镜像
- 最高安全性
- 无shell访问

### 14. Dockerfile.multi-stage
**功能**: 多阶段构建镜像  
**特点**:
- 构建优化
- 依赖分离
- 缓存友好

## 快速部署命令集合

### 一键部署（推荐）
```bash
# 使用SSH密钥部署（最安全）
./deploy-ssh-key.sh

# 使用密码部署（简单快速）
./deploy-to-server.sh

# 简化部署（网络环境差）
./deploy-simple.sh
```

### 手动部署
```bash
# 1. 构建镜像
docker-compose -f docker-compose.alpine.yml build --no-cache

# 2. 启动服务
docker-compose -f docker-compose.alpine.yml up -d

# 3. 检查状态
docker-compose ps
./healthcheck.sh
```

### 服务管理
```bash
# 查看日志
docker-compose logs -f ssh-collector

# 重启服务
docker-compose restart ssh-collector

# 停止服务
docker-compose down

# 更新部署
git pull
docker-compose down
docker-compose build --no-cache
docker-compose up -d
```

## 测试和验证脚本

### API测试脚本
```bash
# 健康检查
curl http://localhost:8000/health

# 设备采集测试
curl -X POST "http://localhost:8000/api/collect" \
  -H "Content-Type: application/json" \
  -d '{
    "host": "192.168.1.1",
    "username": "admin", 
    "password": "password",
    "device_type": "huawei",
    "commands": ["display version"]
  }'
```

### 性能测试脚本
```bash
# 并发测试
for i in {1..10}; do
  curl -X POST "http://localhost:8000/api/collect" \
    -H "Content-Type: application/json" \
    -d '{"host":"192.168.1.1","username":"admin","password":"password","device_type":"huawei","commands":["display version"]}' &
done
wait
```

## 监控脚本

### 服务监控
```bash
#!/bin/bash
# monitor.sh - 服务监控脚本

while true; do
    if ! curl -f http://localhost:8000/health > /dev/null 2>&1; then
        echo "$(date): 服务异常，尝试重启"
        docker-compose restart ssh-collector
        sleep 30
    fi
    sleep 60
done
```

### 资源监控
```bash
#!/bin/bash
# resource_monitor.sh - 资源监控脚本

echo "=== 容器资源使用情况 ==="
docker stats ssh-collector --no-stream

echo "=== 磁盘使用情况 ==="
df -h /opt/ssh-collector

echo "=== 内存使用情况 ==="
free -h
```

## 备份脚本

### 数据备份
```bash
#!/bin/bash
# backup.sh - 数据备份脚本

BACKUP_DIR="/backup/ssh-collector"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR

# 备份数据
tar -czf "$BACKUP_DIR/data_$DATE.tar.gz" /opt/ssh-collector/data/

# 备份日志
tar -czf "$BACKUP_DIR/logs_$DATE.tar.gz" /opt/ssh-collector/logs/

# 备份配置
cp /opt/ssh-collector/docker-compose.yml "$BACKUP_DIR/docker-compose_$DATE.yml"

echo "备份完成: $BACKUP_DIR"
```

## 脚本使用建议

### 生产环境推荐
1. **部署**: `deploy-ssh-key.sh`
2. **配置**: `docker-compose.alpine.yml` + `Dockerfile.alpine`
3. **监控**: `healthcheck.sh` + 自定义监控脚本
4. **备份**: 定期执行备份脚本

### 开发环境推荐
1. **部署**: `deploy-simple.sh`
2. **配置**: `docker-compose.yml` + `Dockerfile`
3. **测试**: `test-images.sh`
4. **调试**: 直接使用docker-compose命令

### 故障排除工具
1. **日志查看**: `docker-compose logs`
2. **健康检查**: `./healthcheck.sh`
3. **容器状态**: `docker-compose ps`
4. **资源监控**: `docker stats`

---

**注意事项**:
1. 所有脚本都需要执行权限：`chmod +x script_name.sh`
2. 部署前请确保服务器满足系统要求
3. 生产环境建议使用SSH密钥认证
4. 定期备份重要数据和配置文件
5. 监控服务状态和资源使用情况

**版本**: 1.0.0  
**更新日期**: 2024-01-22